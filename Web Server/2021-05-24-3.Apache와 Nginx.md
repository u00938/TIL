[Reference](https://cntechsystems.tistory.com/24)
[Reference2](https://cornswrold.tistory.com/429)

실질적으로 작동하는 웹 사이트들에서 쓰는 웹 서버 소프트웨어 순위 1, 2위의 Apache와 Nginx

서버 부담이 비교적 적은 Nginx로 전향하는 추세인데..

왜 Nginx가 Apache보다 서버 부담이 적을까?

## Apache

#### 스레드/ 프로세스 기반 구조

클라이언트 요청 하나 당 스레드 하나가 매칭된다.

요청이 들어오면 스레드를 할당해 준 후, 그 스레드가 작업을 하는 도중 다른 요청이 들어오면 context switching이 일어난다. 새로운 요청에 스레드를 배분하고 다시 작업을 수행하며, 이후 계속해서 context switching을 하며 모든 요청을 처리한다.

사용자가 많을수록 스레드가 증가하기 때문에 CPU와 메모리 낭비가 심하다. 이는 성능의 저하로 이어질 수 있다.

#### MPM 방식 처리

multi-processing modules

![prefork](https://i.imgur.com/wlZthxU.jpg)

- Prefork MPM
  - 하나의 자식 프로세스가 하나의 스레드를 갖는 구조
  - 스레드 간 메모리 공유를 하지 않는다.
  - 실행 중인 프로세스를 복제하여 실행한다. 이 때, 메모리 영역까지 복제된다.
  - 각 프로세스는 한 번에 한 연결만 처리하고, 요청량이 많아질수록 프로세스를 복제하여 동작
  - connection 수 === 프로세스 수
  - 응답 프로세스를 미리 띄워놓고, 클라이언트 요청 시 자식 프로세스가 반응하는 방식
  

![worker](https://i.imgur.com/YLjeB7o.jpg)

- Worker MPM
  - Prefork 보다 메모리 사용량이 적고, 통신량이 많거나 동시 접속자가 많은 사이트에 적합
  - 한 개의 프로세스가 여러 스레드를 사용하여 요청 처리
  - 프로세스 당 최대 64개의 스레드 처리가 가능하고, 각 스레드는 한 번에 한 연결을 담당
  - 스레드 간에 메모리를 공유한다.
  - 일반적으로 Multi CPU 시스템에서 성능이 좋다.

<br>

## Nginx

#### Event-driven 처리 기반 구조

![event](https://i.imgur.com/gdkXZdw.jpg)

여러 개의 연결을 모두 이벤트 핸들러를 통해 비동기 방식으로 처리

요청에 대한 각 상태를 정해 이벤트가 발생할 때마다 이벤트를 처리한다.

한 개 또는 고정된 프로세스만 생성하고, 그 프로세스 내부에서 비동기 방식으로 작업을 처리하기 때문에, 동시 접속 요청이 많아도 프로세스 또는 스레드 생성 비용이 들지 않는다.

스레드를 많이 사용하지 않기 때문에 context switching 비용이 적고 CPU 소모가 낮다.

CPU가 관여하지 않는 모든 I.O 작업들을 전부 이벤트 리스너로 넘기고 기다리지 않고 바로 다른 작업을 수행하다가, 해당 I.O 작업들이 끝나면 이벤트가 발생하여 그 다음 작업을 처리하게 된다. 흐름이 끊기지 않고 응답이 빠르게 진행되어 1개의 프로세스로도 더 빠른 작업이 가능할 수 있다.

<br>

## Apache와 Nginx의 비교

#### 처리 구조

Apache: 요청 당 스레드 또는 프로세스가 처리하는 구조

Nginx: 비동기 이벤트 기반으로 요청 처리

#### 모듈

Apache: 모듈이 다양함

Nginx: Apache에 비해 다양한 모듈이 없음

#### 장점

Apache: PHP 모듈 등 직접 적재 가능

Nginx: 많은 접속자들 대응 가능

#### 우세

Apache: 안정성, 확장성, 호환성 우세

Nginx: 성능 우세

<br>

## 결론

어떤 서버가 더 좋은지 별로인지는 말할 수 없고, 각자 다른 강점을 가지고 있으므로 상황에 맞게 사용하면 된다.

